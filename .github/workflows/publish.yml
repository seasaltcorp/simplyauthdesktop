name: Publish to GitHub Packages (Private)

# Aciona quando cria uma release ou uma tag vX.Y.Z
on:
  release:
    types: [published]
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:      # permite rodar manualmente no GitHub

permissions:
  contents: read         # para checkout
  packages: write        # para publicar no GitHub Packages
  id-token: write        # OIDC (nÃ£o precisa de PAT)

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # IMPORTA A CHAVE GPG PRIVADA (sem senha)
      - name: Import GPG Signing Key (sem passphrase)
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: |
          echo "$SIGNING_KEY" | gpg --batch --import

      # PUBLICAÃ‡ÃƒO
      - name: Publish to GitHub Packages
        env:
          # O GITHUB_TOKEN Ã© injetado automaticamente com permissÃ£o de packages:write
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
        run: |
          ./gradlew publishAllPublicationsToGitHubPackagesRepository \
            -Psigning.keyId=$SIGNING_KEY_ID \
            -Psigning.secretKeyRingFile=$(gpg --list-secret-keys --keyid-format LONG | grep sec | awk '{print $2}' | cut -d/ -f2 | head -n1 | xargs -I {} echo ~/.gnupg/secring.gpg) \
            --no-daemon \
            --stacktrace

      - name: Sucesso!
        run: |
          echo "âœ… SimplyAuthDesktop publicado com sucesso no GitHub Packages!"
          echo "ðŸ”— https://github.com/orgs/seasaltstudio/packages?repo_name=simplyauthdesktop"
